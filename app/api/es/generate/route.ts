import { NextRequest, NextResponse } from "next/server";
import OpenAI from "openai";

type GenerateEsParams = {
  industry: string;
  questionType: "gakuchika" | "self_pr" | string;
  strengthLabel: string;
  episodeText: string;
  targetLength: number;
};

type GenerateEsResult = {
  outline: string[];
  body: string;
  hrAdvice: string[];
  generationNotes: string[];
  bodyLength: number;
};

const CONSULTING_GUIDELINE = `
【コンサルティング・シンクタンク向けの書き方ガイド】

■業界前提（コンサル/シンクタンクが評価するもの）
- 課題設定（論点の切り分け・構造化）
- 仮説思考（原因/打ち手の仮説）
- 検証力（一次情報・データ・比較・反証）
- 実行力（優先順位・意思決定・やり切り）
- 合意形成（関係者調整・巻き込み）
- 定量成果（Before→After 可能な範囲で）
- 学びの再現性（次も使える型）
- シンクタンク要素（社会/制度/長期視点を1文だけ。過剰に盛らない）

■作成ルール
- 「頑張りました」「学びました」等の抽象語で逃げず、読み手が状況を追える具体性を必ず入れる
- 数字が無い場合は、対象人数/頻度/期間/比較/工数などで具体化する
- 誇張はしない。足りない情報は【不明】として置かず、入力エピソードから合理的に補完して自然な表現にする（ただし事実の捏造は禁止）

■推奨構成（必ずこの流れを意識する）
1) 結論（何をした/何を達成）
2) 背景・目的（誰のどんな課題を良くしたい活動か）
3) 課題定義（ボトルネックの特定＝構造化）
4) 仮説（AならBが起きる、という当たりの付け方）
5) 検証と行動（何で確かめ、何を実行したか）
6) 結果（定量/定性）
7) 学び（再現可能な型＋次ならどう動くか）
8) シンクタンク視点の示唆（社会/構造/長期の1文。入れすぎない）

※ 全体としては、このサービス側で指定している基本構成「結論→背景・課題→行動→結果→学び」の流れから大きく外れないようにしつつ、上記8ステップが自然に含まれるように本文を組み立ててください。

■本文づくりで必ず押さえたいポイント
- 「仮説→根拠→検証→結果」の流れが分かるように書く
- 定量（Before/After・母数・比較軸）をできるだけ入れる
- チームの中での「自分の役割」を一文で言えるようにする
- クライアント視点／現場視点／ユーザー視点／経営視点のいずれかが入っている
- 学びは「今後も再現できる型」としてまとめる（次回も同じ考え方で動けるように言語化する）

■この業界でマイナスになりやすいNGパターン
- 「課題解決しました」「成長しました」など抽象語だけで中身がない
- なぜその行動をしたのか（仮説・根拠）が書かれていない
- 自分の貢献が分からず、チームの話だけで終わっている
- 数字が一切なく、成果の大きさが伝わらない
- 一発逆転ストーリーで、改善の反復やプロセスが見えない

■このサービスの出力仕様との対応（hr_advice / generation_notes の書き方）
- hr_advice には、次の2種類の内容を必ず含めること
  - 前半：採用担当に刺さる要点 3つ（箇条書き）。本文のどこが「課題設定・仮説思考・検証力・実行力・合意形成」に優れているかを、評価者目線で短くまとめる。
  - 後半：追加であると強くなる情報（質問形式で2〜3個）。「もし面接ならこう聞きたい」という形で、数字・仮説・検証・ステークホルダーなどの深掘り質問を書いてください。
- generation_notes には、
  - 上記の業界前提のうち、今回特に意識した観点
  - 本文構成で工夫したポイント（どこに仮説/検証/学びを置いたか）
  を、新卒就活生にも分かる言葉で1〜3行程度でまとめてください。
`;

const FINANCE_GUIDELINE = `
【金融向けの書き方ガイド】

■文の基本構造（勝ち筋）
- 結論 → 数字で現状把握 → 課題（または機会）の定義 → 打ち手（判断軸）→ 実行 → 結果 → リスクと再現性
- 背景説明よりも先に、「数字で状況を押さえた感」が出ると強い。

■強調したい価値観
- 誠実さ・信頼性：盛らない、曖昧にしない、ミスを減らす姿勢
- 数字への強さ：率・単価・分解（売上＝客数×単価×回数など）
- リスク管理：想定外を織り込み、最悪ケースや損失限定を考える
- 判断の速さ：100点よりも期限・優先順位を意識した意思決定
- 粘り強さ：根性ではなく、検証サイクルで粘る

■押さえたいポイント
- 数字の分解ができているか（どの指標をどれだけ動かしたか）
- 再現性あるPDCA（施策→計測→改善）が回っているか
- ミスを減らす工夫（チェックリスト、ダブルチェック、手順化など）があるか
- 利害関係者との調整（上司・顧客・チームとの合意形成）が見えるか

■金融ならではの視点
- リスクとリターンをセットで語る（うまくいった話だけで終わらせない）
- 数字の定義に敏感（何を含む／除くか、期間、母数など）
- コンプライアンス・守秘・信頼（ルール順守と情報管理）が担保されているか

■避けたいパターン
- 「稼ぎたい」が前面に出すぎる（責任・信頼・専門性の観点に寄せる）
- 数字が雑／根拠が弱い（「増えた」ではなく「何が・どれだけ・なぜ」まで書く）
- ハイリスク志向に見える話（攻めるなら損失限定や撤退基準もセットで）
- 大きなことだけ語り、実務の正確さが伝わらない構成

■使える言い回しの例
- 「指標を◯◯に定義し、週次でモニタリングした」
- 「打ち手は期待値とリスクで比較し、◯◯を採用した」
- 「損失を限定するため、◯◯の撤退基準を設けた」
- 「再現性担保のため、手順を標準化した」
`;

const MANUFACTURING_GUIDELINE = `
【メーカー向けの書き方ガイド】

■文の基本構造（勝ち筋）
- 結論 → 背景（現場/顧客/制約）→ 工夫（仮説＋試作/改善）→ 周囲巻き込み → 結果 → 再現性（次も活かせる学び）
- 特に「制約の中でどう改善したか」が伝わると強い。

■強調したい価値観
- 顧客価値（ユーザー目線）："作りたい"より"求められている"に寄せる
- 改善・カイゼン：一発で当てるより、検証と改善を回していること
- 品質意識：再現性・標準化・ミス防止の工夫があること
- 協働：部門横断や現場との巻き込み、調整・合意形成
- 責任感：納期・安全・ルールを守りつつ成果を出す感覚

■押さえたいポイント
- 現場理解（現場を見た/触った/観察した経験があるか）
- プロセスで勝つ（原因特定→対策→再発防止まで落とし込めているか）
- QCD（Quality/Cost/Delivery）の感覚があるか、どれを優先しどう両立したか
- 数字や指標（時間短縮、ミス削減、満足度、歩留まりなど）が少しでも入っているか

■メーカーならではの視点
- 顧客の「使う瞬間」まで想像しているか（使いにくさ、導線、安心感、継続性）
- 再現性（標準化・仕組み化）：自分の頑張りだけで終わらせず、仕組みにしているか
- トレードオフの扱い：速さと品質、安全と効率などの矛盾をどう解いたか

■避けたいパターン
- 「モノづくりが好きです」だけで終わる（好き＋価値に変えた話まで書く）
- 抽象的なチームワーク（何を調整してどう合意したかが見えない）
- 気合いだけの成果（改善・仕組み・標準化の要素がない）
- 結果だけ大きくて根拠が薄い（数字が難しければBefore/Afterや指標の定義で補強する）

■使える言い回しの例
- 「現場の制約（納期/品質/コスト）を踏まえ、優先順位を決めて改善した」
- 「原因を分解し、再発防止まで落とし込んだ」
- 「個人の頑張りでなく、手順化して再現性を担保した」
- 「顧客の使用シーンを想定し、使い勝手の課題を潰した」
`;

const TRADING_GUIDELINE = `
【商社向けの書き方ガイド】

■文の基本構造（勝ち筋）
- 結論 → 取り組んだ「取引/プロジェクト」の目的 → 関係者整理 → 課題（利害対立/制約）→ 打ち手（交渉・調整・代替案）→ 実行 → 結果 → 学び（再現性）
- 「自分が何を動かしたか（誰と誰の間に入り、どう前に進めたか）」が伝わると強い。

■強調したい価値観
- 当事者意識：自分が動かなければ止まる状況で主体的に動いているか
- 巻き込み・調整力：関係者の利害をどう整理し、どう揃えたか
- 不確実性への強さ：代替案・バックアップを用意して動けているか
- 収益/価値の構造理解：価格だけでなく、供給安定・品質・納期・信用などの価値も見ているか
- やり切る実行力：交渉だけでなく運用・継続まで落とし込んでいるか

■押さえたいポイント
- 関係者の多さ・複雑さ（顧客、仕入先、社内、外注、行政、ユーザーなど）を整理できているか
- 交渉の設計（相手メリット、譲歩ライン、落とし所）を考えたうえで動いているか
- 数字で成果を見せられているか（コスト◯%削減、納期短縮、継続率向上など）
- リスク管理（供給途絶、品質、納期、為替、信用などにどう手当てしたか）

■商社ならではの視点
- 価値は「つなぐ」ことで生まれる（情報格差を埋める、信用を担保する、物流/品質/資金を整えるなど）
- 短期成果だけでなく継続取引の設計（一発の契約ではなく、続く仕組み・運用）
- 現場と数字の両方を見る（現場の課題→数字で検証→改善）

■避けたいパターン
- 「グローバルに働きたい」だけで終わる（願望でなく、何を動かして価値を出すかを書く）
- 人脈/コミュ力自慢だけで成果が見えない
- 「調整しました」で終わり、誰と誰の利害をどう揃えたかが不明
- 「商社で成長したい」だけで、自分の成長＞相手を勝たせる視点になっている

■使える言い回しの例
- 「関係者と利害を整理し、優先順位を明確化した」
- 「相手メリットを設計し、合意形成を進めた」
- 「想定リスクに対し代替案と撤退基準を用意した」
- 「単発で終わらないよう運用フローまで落とし込んだ」
`;

const IT_GUIDELINE = `
【IT・通信向けの書き方ガイド】

■文の基本構造（勝ち筋）
- 結論 → ユーザー/顧客課題 → 仮説 → 施策（設計）→ 実装/実行 → 数字結果 → 学び（改善サイクル）
- 「どんな課題に対して、どう設計し、どう改善したか」が伝わると強い。

■強調したい価値観
- ユーザー価値：誰のどんな行動・体験・指標を改善したか
- 仮説→検証→改善：PDCAの速さと質（ログ/データ/声を使っているか）
- 構造化・論理性：課題をどう分解し、どこから手を付けたか
- チーム開発/協働：エンジニア・デザイナー・営業・顧客など、利害を揃えて進めたか
- 再現性：仕組み化・ドキュメント化・運用設計があるか
- セキュリティ/信頼性：個人情報や障害リスクへの配慮があるか

■押さえたいポイント
- 定量成果（プロダクト/KPIっぽい指標）
  例：CVR、継続率、解約率、DAU/MAU、作業時間、エラー率、応答速度、問い合わせ件数 など
- 仮説の置き方：「原因は◯◯だと仮説→検証方法は◯◯」が説明できるか
- 改善の設計：A/B比較、ログを見る、ユーザーの声を拾う等で改善しているか
- ステークホルダー対応：関係者と利害を揃えながら進めた経験になっているか

■IT/通信ならではの視点
- スケール/運用の発想：「作って終わり」ではなく運用・保守・改善で価値を出しているか
- 信頼性・安定性：障害を起こさない/影響を抑える/再発防止/監視などへの意識
- 要件と制約：納期・品質・リソースなどの制約下で優先順位を決めた判断があるか

■避けたいパターン
- 「ITで社会を変えたい」だけの抽象的な話（具体の課題・打ち手・検証に落とす）
- 技術や用語の羅列だけで、何を解決したかが見えない構成
- 成果が「感想」で終わる（何がどれだけ改善したかがない）
- 「自分が全部やった」感が強く、チーム開発の文脈が見えない

■使える言い回しの例
- 「課題を分解し、最も影響が大きいボトルネックに絞った」
- 「仮説を置き、ログ/ヒアリングで検証した」
- 「小さく試して、改善を繰り返した」
- 「運用を見据えて手順化・仕組み化した」
- 「影響範囲とリスクを見積もり、段階的に展開した」
`;

const MEDIA_GUIDELINE = `
【広告・マスコミ向けの書き方ガイド】

■文の基本構造（勝ち筋）
- 結論（何を作った/動かした）→ 誰に何を届けたか（ターゲット）→ 気づき（インサイト）→ 企画意図（なぜその表現/切り口）→ 実行（制作・調整）→ 反響/成果 → 学び（次も刺さる型）
- 「なぜその切り口・表現にしたのか」が伝わると強い。

■強調したい価値観
- 生活者/視聴者視点：ターゲットの解像度が高いか
- インサイト発見：本音や隠れたニーズへの理解
- 企画力：切り口×メッセージ×構成の組み立て
- 編集力：情報整理・言葉選び・見せ方の工夫
- 実行力：関係者調整・締切対応・修正対応
- 数字/反響への感度：結果を見て検証・改善しているか
- 倫理観：炎上回避・取材倫理・権利への配慮

■押さえたいポイント
- アウトプットが具体的（企画書、記事、動画、SNS投稿、イベント、広告運用、取材、編集、デザインなど）
- 狙いが言語化されているか（「誰に」「何を」「どう感じて」「どう動いてほしいか」）
- 反響・成果（CV/CTR/CPA/問い合わせ/来店/売上/参加率、PV/滞在時間/完読率/SNS拡散/コメントの質 等）が少しでも見えるか
- 改善プロセス（初稿→反応→修正→伸びた）が書けているか

■広告・マスコミならではの視点
- 広告：クライアント視点×生活者視点の両立（「売りたい」だけでも「ウケたい」だけでもない設計）
- マスコミ：公共性・正確性・多面的視点（正しさと伝わりやすさの両立、取材・裏取り・文脈の扱い）
- 言葉/表現の責任：偏見・差別・誤解を生まない配慮

■避けたいパターン
- 「広告が好き」「テレビが好き」で終わる話（なぜ好きか＝どんな視点で見ているかまで書く）
- センス自慢だけの企画（生活者/視聴者の理解に基づかない）
- バズ＝正義の書き方（数字だけでなくブランド・倫理にも触れる）
- ふわっとした「コミュ力」（誰と何を調整し、どう前に進めたかが見えない）

■使える言い回しの例
- 「ターゲットの“本音”を仮説立てし、表現に落とし込んだ」
- 「伝えたいことではなく、受け手が理解できる順番で編集した」
- 「反応を見て、構成/コピー/サムネを改善した」
- 「数字とコメントの両方から、刺さった理由を検証した」
`;

const RETAIL_DISTRIBUTION_GUIDELINE = `
【小売・流通向けの書き方ガイド】

① どういう書き方？（型：ガクチカ/自己PRで強い流れ）

■基本の型
- 結論
  → 売場/顧客の状況
  → 課題（機会損失）
  → 仮説（なぜ売れない/回らない）
  → 施策（売場/接客/導線/在庫）
  → 実行
  → 結果（数字）
  → 学び（再現性）

■強調したい価値観（刺さる順）
- 顧客視点（買いやすさ・迷わせない）
- 数字感（KPI）（客単価/購買率/回転率/粗利）
- 改善（PDCA）（売場を変えて検証）
- 現場力（スピード＋丁寧さ）
- チーム連携（共有・引き継ぎ・教育）
- 在庫/ロス意識（欠品・廃棄・棚卸）

■トーン
- 明るさはOKだが、文章は簡潔に論理的に。
- “接客の感動話”だけで終わらせず、「仮説→施策→数字」の流れを意識する。

② 必ず押さえたほうがいいこと（評価されやすい要素）

■定量成果（出せると強い）
- 売上、客単価、購買率、リピート率、来店数、廃棄率、欠品率、作業時間 など。

■ボトルネック特定
- 例：認知→手に取る→比較→購入 のどこで落ちているかを整理する。

■打ち手が現場に落ちている
- POP、陳列、導線、声かけ、試食/体験、セット提案、在庫配置、発注ルール など。

■再現性
- 自分がいない日でも回る仕組み（マニュアル/チェック/共有）まで書けると強い。

■小売・流通ならではの視点
- QSC（品質・サービス・清潔）を崩さず改善する意識。
- オペレーション×売上両立（忙しい時でも回る仕組み）。
- ロス（廃棄・値引き）や欠品への感度。
- 顧客体験＝買いやすさ（迷いを減らす）。

③ 避けた方がいいこと（NG・地雷）

■よくある悪いパターン
- 「笑顔で接客しました」だけ
  - → 何を改善して、数字や指標がどう動いたかが必要。
- 売上＝自分の頑張りだけで説明する
  - → 売場/導線/在庫/提案で“再現性”を出す。
- 施策が思いつきで、検証がない。
- 自分プレーで、チーム共有がない。

■マイナスに映りやすい要素
- ルール軽視（レジ/金銭/衛生/防犯）
- クレームを軽く見る姿勢
- 数字に弱そう（改善が感覚頼り）
- ロスや在庫への無関心

■ESで使える「小売っぽい言い回し」の例
- 「購買までの導線でどこが詰まっているかを整理しました」
- 「仮説を立て、売場を変えて検証しました」
- 「欠品/廃棄を減らすために発注・在庫配置を見直しました」
- 「忙しい時間帯でも回るよう、手順を標準化しました」
- 「自分が不在でも再現できるよう共有しました」
`;

const HR_EDU_GUIDELINE = `
【人材・教育向けの書き方ガイド】

■文の基本構造（勝ち筋）
- 結論 → 相手（対象）の状態 → 課題の特定 → 介入設計（支援の打ち手）→ 実行 → 変化（成果）→ 学び（再現性）
- 「教えた/励ました」ではなく、「どう設計して変化を生んだか」が伝わると強い。

■強調したい価値観
- 相手理解：傾聴・観察・質問を通じて相手の状態を正しく捉えているか
- 信頼構築：安心感・約束を守る・誠実さが伝わるか
- 伴走力：継続させる仕組みや導線を作れているか
- 成果志向：就職決定/定着/成績/継続率など、変化に責任を持っているか
- 公平性・倫理観：ミスマッチ回避、安全配慮、差別しない、個人情報への配慮

■押さえたいポイント
- 相手の変化が定量または定性で明確に書かれているか
  例：面談継続率、参加率、内定率、定着率、成績、提出率、学習時間、発言や行動の具体的な変化 など
- 支援の設計があるか（ヒアリング→課題仮説→提案→選択→実行→振り返り）
- 1回で終わらず、継続させる導線や仕組みがあるか
- 関係者（人材：候補者×企業×社内、教育：生徒×保護者×学校×運営）を巻き込めているか
- ミスマッチ回避の視点（決めるだけでなく、合わない場合は止める判断も含めているか）

■避けたいパターン
- 精神論だけ（寄り添った/応援した だけで終わる）
- 成果＝「相手が頑張った」で終わり、自分の介入の価値が見えない構成
- 過度な介入・コントロール（自立支援の観点がなく、相手を支配している印象）
- 売上至上主義に見える書き方（人材で数字だけを押しすぎる 等）

■マイナスに映りやすい要素
- 個人情報を軽く扱っている雰囲気
- 相手をラベリングする表現（「この人はダメ」など）
- 誇張・断言（「絶対大丈夫」など）
- 自分の正しさの押し付け

■使える言い回しの例
- 「相手の不安の“正体”を質問で特定した」
- 「行動が続くように、選択肢と次アクションをセットで提示した」
- 「短期成果だけでなく、ミスマッチを防ぐ観点で提案した」
- 「再現性を担保するため、面談/指導フローを標準化した」
`;

const MEDICAL_WELFARE_GUIDELINE = `
【医療・福祉向けの書き方ガイド】

① どういう書き方？（型：ガクチカ/自己PRで強い流れ）

■基本の型
- 結論
  → 対象（誰のどんな状況）
  → 課題（安全/不安/継続/連携）
  → 介入（観察・工夫・支援設計）
  → 実行（連携/記録）
  → 結果（変化）
  → 学び（再現性）

※ 医療・福祉は「感動話」より、「安全に、丁寧に、継続できる形にした」エピソードが評価されやすい。

■強調したい価値観（優先度）
- 倫理観・尊厳（相手を尊重する）
- 安全配慮・リスク管理（事故・感染・転倒・誤薬・情報管理など）
- 観察力・傾聴（小さな変化に気づく）
- チーム連携（報連相・記録・引き継ぎ）
- 継続支援の設計（無理なく続く仕組み）
- 改善（再発防止）（ヒヤリハット→対策）

■トーン
- 誠実・落ち着き・丁寧
- 熱量は「言葉」ではなく、配慮の具体で見せる
- 「できる/できない」の線引きを明確にし、断言しすぎない表現を心がける

② 必ず押さえたほうがいいこと（評価されやすい要素）

■安全配慮の具体がある
- 例：確認手順、声かけ、動線、衛生、二重チェック、ルール順守 など

■個別性を理解している
- 「その人に合わせて」だけでなく、何を見て合わせたか（体調/生活/不安/家族背景 等）を書く。

■記録と共有
- 気づき→記録→共有→対応 が書けていると強い。

■関係者対応
- 利用者/患者本人だけでなく、家族・他職種・施設内連携の視点が入っているか。

■業界ならではの視点
- 守秘義務・個人情報
  - ESでは固有名詞や詳細を書きすぎず、一般名詞に置き換える。
- 正確さ＞スピード
  - 「早く回す」アピールより「ミスを防ぐ」姿勢が評価される。
- 「治す/解決する」より「生活を支える」発想（福祉寄り）
  - 日常の継続、自己決定支援、QOLなどへの意識。

③ 避けた方がいいこと（ESで落ちるパターン）

■よくあるNG
- 「人の役に立ちたい」だけで終わる
  - → 観察→工夫→連携→変化 までが必要。
- 感動エピソードだけ（プロセスがない）
- 「自分が救った」系の書き方
  - → 上から目線に見えやすい。支援・伴走の語彙を使う方が安全。
- ルールを越えた武勇伝
  - → 医療・福祉ではNG。ルール遵守が前提。

■マイナスに映りやすい要素
- 個人情報の扱いが雑そうに見える
- 決めつけ（「この人はこう」）が強い
- チームより単独プレーに見える
- 不安定さ（感情で振り回されそうな印象）

■ESで使える「学生でも使いやすい言い回し」の例
- 「相手の負担を増やさないよう、まず観察して状況を整理しました」
- 「安全面を優先し、確認手順を徹底しました」
- 「気づきを記録し、チームと共有して対応を揃えました」
- 「本人の意思を尊重し、選べる形で支援しました」
- 「再発防止のため、手順を見直して仕組みにしました」
`;

const INFRA_GUIDELINE = `
【交通・インフラ向けの書き方ガイド】

■文の基本構造（勝ち筋）
- 結論 → 背景（公共性・影響範囲）→ 課題（安全/品質/遅延/効率）→ 取った行動（手順・連携・改善）→ 結果 → 学び（再現性・安全文化）
- 「派手な挑戦」よりも、「事故らせない・止めない・乱れを最小化する」方向のエピソードが評価されやすい。

■強調したい価値観
- 安全・確実性：ミスを防ぐための具体的な工夫があるか
- 責任感：自分の仕事の影響範囲（利用者・社会）を理解しているか
- リスク管理：想定・備え・再発防止ができているか
- チームワーク：連携・引き継ぎ・報連相が徹底されているか
- 現場主義：一次情報・運用理解に基づいて動けているか
- 改善：小さな改善を積み上げている姿勢
- 顧客/利用者視点：安心・分かりやすさ・不安低減を意識しているか

■押さえたいポイント
- 安全を担保する行動が具体的（チェック、ダブルチェック、手順書、声かけ、指差呼称、ヒヤリハット共有など）
- 安定運用の視点（トラブル時の優先順位、復旧、影響最小化）
- 関係者連携（現場/上司/関連部署/顧客への連絡・調整）
- 改善の成果（遅延減、ミス削減、待ち時間短縮、問い合わせ減、コスト削減など）。数字が難しければ頻度・件数・工数でも良い。

■業界ならではの視点
- 公共性：社会を止めない、自分の仕事が誰にどう影響するかを理解しているか
- ルール遵守・規程の重み：“臨機応変”よりも、ルール内で工夫した話が強い
- 異常時対応：平常時の効率化よりも、異常時の判断や動き方が評価されやすい

■避けたいパターン
- 「スピード感」「攻め」を前に出しすぎる（安全より攻めに見える）
- ルール軽視っぽいエピソード（本来NGなことを工夫として語る）
- 個人プレー自慢（引き継ぎや報連相が見えない）
- トラブルを美談化して終わる（再発防止・仕組み化が主役になっていない）

■マイナスに映りやすい要素
- ヒューマンエラーへの配慮がない
- 「慣れで回す」雰囲気
- クレーム/苦情を軽く見ている
- 利用者視点が欠けている（不便や不安への想像力がない）

■使える言い回しの例
- 「影響範囲を考え、優先順位を安全第一で判断した」
- 「手順を標準化し、ヒューマンエラーを減らした」
- 「異常時を想定し、連絡フローと代替策を整えた」
- 「再発防止のため、仕組みに落とし込んだ」
- 「利用者の不安を減らすため、案内/導線を改善した」
`;

const REAL_ESTATE_GUIDELINE = `
【不動産・建設向けの書き方ガイド】

■文の基本構造（勝ち筋）
- 結論 → プロジェクト/顧客の目的 → 制約（予算・納期・品質・法規）→ 課題（ボトルネック）→ 打ち手（段取り・調整・改善）→ 結果（数字/品質/期限）→ 学び（再現性）
- 「アイデア」よりも、制約下で前に進める力が伝わると強い。

■強調したい価値観
- 段取り・工程管理：納期を守るための具体的な工夫
- 関係者調整：顧客/協力会社/社内/近隣などの利害をどう揃えたか
- リスク管理：安全・法規・品質・契約への配慮
- 顧客視点：住む人/使う人の価値（安心・利便性・長期の満足）
- 数字感：採算・コスト意識（収益性や原価、工数など）
- 現場主義：現場に入り、一次情報をもとに泥臭く動いているか

■押さえたいポイント
- 制約条件の扱い：予算内で品質確保、納期厳守、法規順守、安全担保
- 調整の具体：誰と誰の認識差をどう埋めたか
- 品質/安全の視点：建設は特に「安全文化」が評価対象
- 採算・コスト意識：
  不動産：収益性、空室率、稼働、LTV、管理コスト
  建設：原価、手戻り削減、工数、資材ロス
  ※数字が難しければ「工数」「手戻り回数」「待ち時間」「クレーム件数」「失注率」でも良い。

■業界ならではの視点
- 成果＝完成/契約だけでなく運用まで（入居後の満足、クレーム抑制、資産価値、維持管理など）
- 法規・契約・近隣配慮：ここが弱いと「危なっかしい人」に見える
- 情報の非対称性を埋める：顧客の不安を減らす説明力

■避けたいパターン
- 「街づくりに憧れ」だけで終わる（抽象でなく具体の価値に落とす）
- 交渉・調整を「コミュ力」で片付ける（合意形成のプロセスを書く）
- リスク感度が低く見える（法規/安全/品質への配慮がない）
- 個人プレー自慢（チームや関係者の動かし方が見えない）

■マイナスに映りやすい要素
- ルール軽視（「柔軟に対応」で押し切る感じ）
- 安全軽視・無理な短縮自慢
- クレームを軽視（顧客/近隣の感情を雑に扱う）
- 数字がふわっとしていて採算が読めない印象

■使える言い回しの例
- 「制約（予算/納期/品質）を前提に最適解を設計した」
- 「論点を整理し、関係者の合意形成を進めた」
- 「手戻りを防ぐため、要件を明文化しチェック工程を入れた」
- 「リスク（法規/安全/近隣）を洗い出し、先回りで対策した」
- 「引渡し後の運用まで見据えて提案した」
`;

const TRAVEL_TOURISM_GUIDELINE = `
【旅行・観光向けの書き方ガイド】

① どういう書き方？（型：ガクチカ）

■基本の型
- 結論（何を成し遂げた）
  → 状況（誰に/どんな現場）
  → 課題（不安/不便/機会損失）
  → 工夫（導線・段取り・配慮）
  → 実行
  → 結果（数字 or 反応）
  → 学び（再現性）

■強調する価値観（ESで刺さる順）
- 顧客視点（不安の先回り）
- 現場運用力（段取り＋臨機応変）
- 安全・リスク管理
- 協働（社内/店舗/地域/チーム）
- 改善（同じ問題を繰り返さない）
- 収益感度（単価・満足→リピート）

■トーン
- 明るさはOK。ただし文章は「落ち着いて具体的に」。
- 感情表現は1行までにして、主役は「行動」と「結果」。

② 必ず押さえること（ESで評価される要素）

■成果が見える形
- 数字（客単価/参加率/待ち時間/クレーム件数/口コミ数 など）
- 数字が難しい場合は、比較（以前より/従来より/平均より）で具体化する。

■「体験の導線」を改善した話
- 予約→来店→案内→体験→購入→解散 のどこを良くしたかをはっきりさせる。

■トラブル対応は「備え」「再発防止」まで
- その場の対応だけだと弱いので、今後同じことが起きないようにどう仕組み化したかを書く。

■多様な人への配慮が具体
- 言語・文化差・年齢・家族連れ・食制限・天候・交通乱れ などへの配慮が分かるように書く。

③ 避けた方がいいこと（ESで落ちるパターン）

- 「旅行が好き」「人が好き」だけで終わる話
- 精神論（明るく頑張った だけ）
- トラブルを美談化して終わる（再発防止がない）
- 主語が自分だけで、お客様/チーム/地域が見えない構成
- ルール軽視に見える表現（時間・安全・規定を“柔軟に突破”したように見える書き方）
`;

// 将来的にここに LLM や RAG のロジックを実装する
async function generateEsWithLlm(params: GenerateEsParams): Promise<GenerateEsResult> {
  const apiKey = process.env.OPENAI_API_KEY;

  // APIキーが未設定の場合は既存のダミー実装にフォールバック
  if (!apiKey) {
    const outline = [
      `結論：${params.strengthLabel} を軸にした経験`,
      "背景・課題：どのような状況・課題だったか",
      "行動：具体的にどのように動いたか",
      "結果：数値や変化を含めた成果",
      "学び・今後の活かし方：志望業界でどう活かすか",
    ];

    const body =
      `${params.industry.toUpperCase()} 業界向けの${
        params.questionType === "gakuchika" ? "ガクチカ" : "自己PR"
      }として、\n` +
      `「${params.strengthLabel}」を軸に、以下のエピソードをもとに構成します。\n\n` +
      `${params.episodeText}\n\n` +
      `（目安文字数：約${params.targetLength}字）\n\n` +
      `※ 現時点ではダミー生成です。後ほど実際のRAG+LLMで本番用の文章に置き換えます。`;

    const hrAdvice = [
      "このエピソードは、あなたの強みがよく伝わる良い経験だと思います。",
      "もし可能であれば、もう少し数字（Before/After や母数）を補足すると、より説得力が増します。",
      "あなた自身の役割や工夫が一文で言えるように意識すると、評価者の印象に残りやすくなります。",
      "このエピソードにはまだ伸びしろがあります。詳しくお話を聞ければ、さらに具体的なアドバイスができそうですし、このエピソードが磨かれるほどES全体の評価も上がっていきます。",
    ];

    const generationNotes = [
      "与えられたエピソードから強みが伝わるように、結論と行動の流れを意識して構成しました。",
      "数字やBefore/Afterが入るとより金融・メーカー・コンサルなどの業界で評価されやすくなる想定で書いています。",
    ];

    const bodyLength = body.length;

    return { outline, body, hrAdvice, generationNotes, bodyLength };
  }

  const client = new OpenAI({ apiKey });

  const guideline =
    params.industry === "consulting"
      ? CONSULTING_GUIDELINE
      : params.industry === "finance"
      ? FINANCE_GUIDELINE
      : params.industry === "manufacturing"
      ? MANUFACTURING_GUIDELINE
      : params.industry === "trading"
      ? TRADING_GUIDELINE
      : params.industry === "it"
      ? IT_GUIDELINE
      : params.industry === "media"
      ? MEDIA_GUIDELINE
      : params.industry === "hr_education"
      ? HR_EDU_GUIDELINE
      : params.industry === "medical_welfare"
      ? MEDICAL_WELFARE_GUIDELINE
      : params.industry === "infra"
      ? INFRA_GUIDELINE
      : params.industry === "real_estate"
      ? REAL_ESTATE_GUIDELINE
      : params.industry === "travel_tourism"
      ? TRAVEL_TOURISM_GUIDELINE
      : "";

  // LLM に構成案・本文・人事アドバイス・今回意識したポイントを JSON 形式で生成させる
  const completion = await client.chat.completions.create({
    model: "gpt-4.1-mini",
    messages: [
      {
        role: "system",
        content:
          "あなたは日本の就活エントリーシート作成を支援するプロのキャリアアドバイザー兼人事担当です。" +
          "新卒学生向けのガクチカ／自己PRとしてふさわしい文章だけを作成してください。" +
          "ユーザーが与えたエピソードから、志望業界・設問タイプに合わせて高品質なESを日本語で作成してください。" +
          "本文（body）は、就活生本人がエントリーシートに実際に書く文章として、一人称『私』を用いた丁寧語（です・ます調）で自然に書いてください。" +
          "構成は意識しつつも、見出しや番号、箇条書きは本文中に出さず、普通の段落として読めるようにしてください。" +
          "本文（body）は必ず2〜4つ程度の段落に分けてください。各段落の末尾には実際の改行コード（\\n\\n）を入れ、1つの段落の中では文の途中で改行しないでください。つまり、段落と段落の間だけ空行1行（\\n\\n）で区切り、1つの長い塊として返さないでください。" +
          "『金融業界では〜が求められます』『〇〇業界では〜です』のような業界一般論や教科書的な説明は書かないでください。あくまで『学生本人の経験・強み・行動・結果・学び』が主役になるようにしてください。" +
          "中途採用向けの職務経歴書のようなトーンではなく、新卒らしい素直さ・成長実感・これからの意欲が伝わる文章にしてください。" +
          "本文の最後は、『だから自分はこういう強みがあり、その強みを志望企業（貴社）の〇〇のような業務でこう活かしていきたい』という形で、新卒らしい前向きなアピールで締めてください。ここでは『金融業界』『メーカー業界』など業界名を繰り返さず、『貴社』『こうした環境』といった表現を用い、できるだけ具体的な仕事イメージ（例：法人営業、企画、開発、運用 など）と強みのつながりを示してください。" +
          "個人名・大学名・企業名などの具体的な固有名詞は出さず、一般的な表現に置き換えてください。" +
          "出力は必ず JSON 形式で、outline（構成の配列）、body（本文1本）、hr_advice（人事からのアドバイス配列）、generation_notes（今回意識したポイントの配列）の4つのキーだけを含めてください。",
      },
      {
        role: "user",
        content:
          `志望業界: ${params.industry}\n` +
          `設問タイプ: ${
            params.questionType === "gakuchika" ? "ガクチカ" : "自己PR"
          }\n` +
          `強み: ${params.strengthLabel}\n` +
          `文字数目安: 約${params.targetLength}字\n` +
          `エピソード本文:\n${params.episodeText}\n\n` +
          (guideline
            ? "この志望業界では、次のガイドラインに従ってESを書いてください:\n" +
              guideline +
              "\n\n" +
              "ES本文とアドバイスでは、上記ガイドラインのうち特に重要だと思う観点に必ず触れてください。ガイドラインの見出しや箇条書きをそのまま本文に書くのではなく、就活生本人の経験や気づきとして自然な文章に落とし込んでください。\n\n"
            : "") +
          "さらに、generation_notes では『このESを書くときにAIがどんなことを大事にしたか』を、学生にもわかるやさしい日本語で2〜4個、箇条書きで説明してください。例えば『結論を最初に書いて、何をアピールしたいかをはっきりさせました』『結果の数字を入れて、どれくらい良くなったかがパッとわかるようにしました』『学んだことを、今後どんな仕事で活かしたいかまで書きました』のように、「どこを足したか・どこを短くしたか・どこを強く伝えようとしたか」がイメージできる書き方にしてください。業界の専門用語や難しい言葉はできるだけ使わず、高校生でも読めるレベルの表現にしてください。\n\n" +
          "以下の条件でESを作成してください:\n" +
          "- 構成は『結論→背景・課題→行動→結果→学び・今後の活かし方』を基本としますが、本文中に見出しや番号をそのまま書かず、自然な段落として表現してください。\n" +
          "- 与えられたエピソード以外の事実を勝手に作らないこと。足りない部分は、論理的に補完しても違和感のない範囲で補ってください。\n" +
          "- 読みやすく、就活の選考で通過しやすいレベルの日本語で書くこと。専門用語の多用は避け、就活生らしい言葉で表現してください。\n" +
          "- さらに、人事担当として、このエピソード（学生時代に力を入れた経験）をより良いガクチカに育てるためのアドバイスを hr_advice に日本語で3〜4個、箇条書きで出してください（最大4個まで）。アドバイスの主な対象は『ユーザーが入力したエピソード本文そのもの』であり、ES全体よりもエピソードの掘り下げ方や書き方にフォーカスしてください。上で示した業界ごとのガイドラインの観点も踏まえてコメントしてください。\n" +
          "  - 1つ目は、必ずこのエピソードの良い点を具体的にほめてください（どの場面・どの行動が特に良いかを指摘してください）。\n" +
          "  - 2〜3つ目は、『もっとこうすればさらに良くなる』という前向きな改善提案を書いてください。特に、数字（回数・人数・成果の変化など）を足す、主人公である自分の行動を一文で言い切る、背景やきっかけを少し詳しくするなど、エピソードを深掘りする具体的なポイントを伝えてください。難しい専門用語はできるだけ避け、就活生にもパッとイメージできるようにやさしく説明してください。\n" +
          "  - 最後は『このエピソードにはまだ可能性がある』『自分でもう一度振り返って言葉を足していけば、もっと伝わるガクチカになります』『このエピソードがより良くなればES全体の評価も上がる』といった、学生自身の工夫や成長を応援する前向きなメッセージで締めてください。『面接で詳しく話を聞きたい』『直接話せばさらにアドバイスできる』といった表現は使わないでください。また、『このエピソードはすでに基盤がしっかりしています。もう一度振り返って数字や具体的な行動を言葉で補えば、より魅力的なガクチカになります。そうすればES全体の評価も高まるはずです。』のような定型文をそのまま使わず、似た内容でも別の言い回しで書いてください。\n" +
          "  - トーンは、やさしくフレンドリーで話しかけるような口調にしつつ、プロの人事としての目線も感じられるようにしてください。『〜だと思います』『〜してみるのがおすすめです』『〜してみるのはいかがでしょうか』のような、就活生に寄り添ったカジュアルめの敬語を使い、堅すぎるビジネス文章にならないようにしてください。学生が『これなら直してみよう』と思える、あたたかい書き方にしてください。\n" +
          "- 出力は必ず次の JSON 形式で返してください:\n" +
          '{"outline": ["...", "..."], "body": "...", "hr_advice": ["...", "..."], "generation_notes": ["...", "..."]}',
      },
    ],
    response_format: { type: "json_object" },
    temperature: 0.7,
  });

  const content = completion.choices[0]?.message?.content;

  if (!content) {
    throw new Error("LLMからの応答が空でした");
  }

  let parsed: any;
  try {
    parsed = JSON.parse(content);
  } catch (e) {
    throw new Error("LLMからの応答JSONのパースに失敗しました");
  }

  const outline = Array.isArray(parsed.outline) ? parsed.outline.map(String) : [];
  const body = typeof parsed.body === "string" ? parsed.body : "";
  const hrAdvice = Array.isArray(parsed.hr_advice)
    ? parsed.hr_advice.map(String).slice(0, 4)
    : [];
  const generationNotes = Array.isArray(parsed.generation_notes)
    ? parsed.generation_notes.map(String)
    : [];

  const bodyLength = body.length;

  return { outline, body, hrAdvice, generationNotes, bodyLength };
}

// ES自動生成用のAPI
// いまは generateEsWithLlm 内部がダミー実装だが、インターフェースはこのまま維持する想定
export async function POST(req: NextRequest) {
  const body = await req.json().catch(() => null);

  const industry = body?.industry as string | undefined;
  const questionType = body?.questionType as string | undefined;
  const strengthLabel = body?.strengthLabel as string | undefined;
  const episodeText = body?.episodeText as string | undefined;
  const targetLength = Number(body?.targetLength ?? 500);

  if (!industry || !questionType || !strengthLabel || !episodeText) {
    return NextResponse.json(
      { error: "industry, questionType, strengthLabel, episodeText は必須です" },
      { status: 400 }
    );
  }

  const result = await generateEsWithLlm({
    industry,
    questionType,
    strengthLabel,
    episodeText,
    targetLength,
  });

  return NextResponse.json(result);
}
